services:
  api-gateway:
    build:
      context: .
      dockerfile: apps/api-gateway/Dockerfile
      target: ${NODE_ENV:-development}
    container_name: api-gateway
    restart: unless-stopped
    ports:
      - '${PORT:-3000}:3000'
    env_file:
      - .env.docker
    image: quynguyen1908/phone-store-api-gateway:latest
    volumes:
      - ./apps/api-gateway:/app/apps/api-gateway:ro
      - ./libs:/app/libs:ro
      - ./package.json:/app/package.json:ro
      - ./package-lock.json:/app/package-lock.json:ro
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - frontend-network
      - backend-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "${API_GATEWAY_HEALTHCHECK_URL:-http://localhost:3000/api/v1/health}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  auth-service:
    build:
      context: .
      dockerfile: apps/auth-service/Dockerfile
      target: ${NODE_ENV:-development}
    container_name: auth-service
    restart: unless-stopped
    ports:
      - '${AUTH_SERVICE_PORT:-3001}:3001'
    env_file:
      - .env.docker
    image: quynguyen1908/phone-store-auth-service:latest
    volumes:
      - ./apps/auth-service:/app/apps/auth-service:ro
      - ./libs:/app/libs:ro
      - ./prisma/user:/app/prisma/user:ro
      - ./package.json:/app/package.json:ro
      - ./package-lock.json:/app/package-lock.json:ro
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "node", "healthcheck.js"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 384M

  user-service:
    build:
      context: .
      dockerfile: apps/user-service/Dockerfile
      target: ${NODE_ENV:-development}
    container_name: user-service
    restart: unless-stopped
    ports:
      - '${USER_SERVICE_PORT:-3002}:3002'
    env_file:
      - .env.docker
    image: quynguyen1908/phone-store-user-service:latest
    volumes:
      - ./apps/user-service:/app/apps/user-service:ro
      - ./libs:/app/libs:ro
      - ./prisma/user:/app/prisma/user:ro
      - ./package.json:/app/package.json:ro
      - ./package-lock.json:/app/package-lock.json:ro
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "node", "healthcheck.js"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 384M

  phone-service:
    build:
      context: .
      dockerfile: apps/phone-service/Dockerfile
      target: ${NODE_ENV:-development}
    container_name: phone-service
    restart: unless-stopped
    ports:
      - '${PHONE_SERVICE_PORT:-3003}:3003'
    env_file:
      - .env.docker
    image: quynguyen1908/phone-store-phone-service:latest
    volumes:
      - ./apps/phone-service:/app/apps/phone-service:ro
      - ./libs:/app/libs:ro
      - ./prisma/phone:/app/prisma/phone:ro
      - ./package.json:/app/package.json:ro
      - ./package-lock.json:/app/package-lock.json:ro
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "node", "healthcheck.js"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 384M

  order-service:
    build:
      context: .
      dockerfile: apps/order-service/Dockerfile
      target: ${NODE_ENV:-development}
    container_name: order-service
    restart: unless-stopped
    ports:
      - '${ORDER_SERVICE_PORT:-3004}:3004'
    env_file:
      - .env.docker
    image: quynguyen1908/phone-store-order-service:latest
    volumes:
      - ./apps/order-service:/app/apps/order-service:ro
      - ./libs:/app/libs:ro
      - ./prisma/order:/app/prisma/order:ro
      - ./package.json:/app/package.json:ro
      - ./package-lock.json:/app/package-lock.json:ro
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "node", "healthcheck.js"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 384M

  payment-service:
    build:
      context: .
      dockerfile: apps/payment-service/Dockerfile
      target: ${NODE_ENV:-development}
    container_name: payment-service
    restart: unless-stopped
    ports:
      - '${PAYMENT_SERVICE_PORT:-3005}:3005'
    env_file:
      - .env.docker
    image: quynguyen1908/phone-store-payment-service:latest
    volumes:
      - ./apps/payment-service:/app/apps/payment-service:ro
      - ./libs:/app/libs:ro
      - ./prisma/payment:/app/prisma/payment:ro
      - ./package.json:/app/package.json:ro
      - ./package-lock.json:/app/package-lock.json:ro
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "node", "healthcheck.js"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 384M
  
  voucher-service:
    build:
      context: .
      dockerfile: apps/voucher-service/Dockerfile
      target: ${NODE_ENV:-development}
    container_name: voucher-service
    restart: unless-stopped
    ports:
      - '${VOUCHER_SERVICE_PORT:-3006}:3006'
    env_file:
      - .env.docker
    image: quynguyen1908/phone-store-voucher-service:latest
    volumes:
      - ./apps/voucher-service:/app/apps/voucher-service:ro
      - ./libs:/app/libs:ro
      - ./prisma/voucher:/app/prisma/voucher:ro
      - ./package.json:/app/package.json:ro
      - ./package-lock.json:/app/package-lock.json:ro
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "node", "healthcheck.js"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 384M

  ai-service:
    build:
      context: .
      dockerfile: apps/ai-service/Dockerfile
      target: ${NODE_ENV:-development}
    container_name: ai-service
    restart: unless-stopped
    ports:
      - '${AI_SERVICE_PORT:-4000}:4000'
    env_file:
      - .env.docker
    image: quynguyen1908/phone-store-ai-service:latest
    volumes:
      - ./apps/ai-service:/app/apps/ai-service:ro
      - ./libs:/app/libs:ro
      - ./package.json:/app/package.json:ro
      - ./package-lock.json:/app/package-lock.json:ro
      - ./data:/app/data
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "${AI_SERVICE_HEALTHCHECK_URL:-http://localhost:4000/api/v1/health}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 384M

  postgres:
    image: postgres:16-alpine
    container_name: postgres-multi-db
    restart: unless-stopped
    ports:
      - '127.0.0.1:5432:5432'
    env_file:
      - .env.docker
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./multiple-databases.sh:/docker-entrypoint-initdb.d/multiple-databases.sh:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: unless-stopped
    ports:
      - '127.0.0.1:6333:6333'
    env_file:
      - .env.docker
    volumes:
      - qdrant_data:/qdrant/storage
      - ./qdrant/config.yaml:/qdrant/config/config.yaml:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://localhost:6333/readyz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - backend-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    restart: unless-stopped
    ports:
      - '127.0.0.1:5672:5672'
      - '127.0.0.1:15672:15672'
    env_file:
      - .env.docker
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    ports:
      - '9090:9090'
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "9090"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - '${GRAFANA_PORT:-3007}:3000'
    env_file:
      - .env.docker
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      prometheus:
        condition: service_healthy
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.18.8
    container_name: elasticsearch
    restart: unless-stopped
    environment:
      - node.name=es01
      - cluster.name=mobile-shop-cluster
      - discovery.type=single-node
      - xpack.security.enabled=true
      - xpack.security.http.ssl.enabled=false
      - monitoring.collection.enabled=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - bootstrap.memory_lock=true
    ulimits:
      memlock: -1
      nofile: 65536
    ports:
      - '9200:9200'
    env_file:
      - .env.docker
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "curl", "-f", "-u", "elastic:${ELASTIC_PASSWORD}", "http://localhost:9200/"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1.5G
        reservations:
          memory: 1G
        
  kibana:
    image: docker.elastic.co/kibana/kibana:8.18.8
    container_name: kibana
    restart: unless-stopped
    ports:
      - '5601:5601'
    env_file:
      - .env.docker
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5601/api/status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

volumes:
  postgres_data:
    driver: local
  qdrant_data:
    driver: local
  rabbitmq_data:
    driver: local
  api_gateway_node_modules:
    driver: local
  auth_service_node_modules:
    driver: local
  user_service_node_modules:
    driver: local
  phone_service_node_modules:
    driver: local
  order_service_node_modules:
    driver: local
  payment_service_node_modules:
    driver: local
  voucher_service_node_modules:
    driver: local
  ai_service_node_modules:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  elasticsearch_data:
    driver: local

networks:
  frontend-network:
    driver: bridge
  backend-network:
    driver: bridge